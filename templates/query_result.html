{% extends "main_page.html" %}
{% block body %}
<div class="container" style="margin-top:10px">
  <!-- Left info bar -->
  <div class="row">
    <div class="col-sm-2">
      <h3>Overview</h3>
      <!--<p>Optional info here.</p>-->
      <ul class="nav nav-pills flex-column">
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('index') }}">Select image</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="#">Query results</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Settings</a>
        </li>
      </ul>
      <hr class="d-sm-none">
    </div>

    <div class="col-sm-9">
      <h1 class="page-header">Input image</h1>

      <!-- Displaying the input image and its information -->
      <div class="img_container">
        <img src={{input_info[0]}} >
        <div class="img_info">
          <p> <b>Image Name:</b> {{input_info[1][0]}}</p>
          <p> <b>IRMA Code:</b> {{input_info[1][1]}}</p>

          <p> <b>Info: </b> </p>
          {% for info in input_info[1][2] %}
            <p> {{info}}</p>
          {% endfor %}
        </div>
      </div>

      <!-- Displaying the query result and their information -->
      <h1 > Query Results</h1>
      {% for img_info in query_result_info %}
        <section class="img_container">
          <img class="query_img" src={{img_info[0]}} onclick="click_on_image(this)" >
          <div class="img_info">

              <p> <b>Image Name:</b> {{img_info[2][0]}}</p>
              <p> <b>Features Distance:</b>  {{img_info[1]}}</p>
              <p> <b>IRMA Code:</b> {{img_info[2][1]}}</p>

              <p> <b>Info: </b> </p>
              {% for info in img_info[2][2] %}
                <p> {{info}}</p>
              {% endfor %}

          </div>
        </section>
      {% endfor %}


      <div style="height: 200px"></div>
      <div class="text-center" style="text-align:center">
        <form id="add_new_page" action="{{ url_for('new_page') }}" method="POST" enctype="multipart/form-data">
          <button type="submit" class="btn btn-primary" id="load_more" onclick="activate_spinner(this)"
            style="visibility:hidden">Load more...</button>
        </form>
      </div>
      <div style="height: 50px"></div>
    </div>
    <div class="col-">
      <div class="text-right" style="position: fixed">
        <button type="submit" class="btn btn-primary" id="relevance_feedback"
          onclick="activate_spinner(this);relevance_feedback()" style="">Relevance feedback!</button>
      </div>
    </div>
  </div>
</div>
</body>

<script>
  var selected_img = []
  // function to select/deselect images
  function click_on_image(el) {
    var link = el.src;
    var img_name = link.substring(link.lastIndexOf("/") + 1);

    if (!selected_img.includes(img_name)){
      selected_img.push(img_name);
      el.style.border = "3px solid blue";
    }else{
      selected_img = arrayRemove(selected_img, img_name)
      el.style.border = "3px solid white";
    }

  console.log(selected_img);
  }

  function relevance_feedback() {

    let non_relevant = build_non_relevant_arr(selected_img);
    let data = [selected_img, non_relevant]

    fetch('/relevance_feedback', {

      method: 'POST',
      mode: 'cors',
      redirect: 'follow',
      headers:  {
        'Content-Type': 'application/json'
        },
      body: JSON.stringify(data)

    })
    .then(function(response) {
    if (response.status !== 200) {
      console.log(`Looks like there was a problem. Status code: ${response.status}`);
      return;
    }
    window.location.href = "/relevance_feedback";
    })  
  }

  function build_non_relevant_arr(relevant_arr) {
    non_rel_img = []
    html_ls = document.getElementsByClassName("query_img");
    for(let i = 0; i < html_ls.length; i++) {
      let e = html_ls.item(i).src
      let img_name = e.substring(e.lastIndexOf("/") + 1)
      if(!relevant_arr.includes(img_name) )  {
        non_rel_img.push(img_name)
      }
    }

    console.log(non_rel_img);
    return non_rel_img

  }

  // function which is called when you're at the bottom of the page
  window.onscroll = function (ev) {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
      // TODO: show button to load more images
    }
  };

  function arrayRemove(arr, value) {
   return arr.filter(function(ele){
       return ele != value;
   });
  }

</script>

</html>
{% endblock %}